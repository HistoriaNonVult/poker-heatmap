<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德州扑克胜率热力图</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a dark theme and layout similar to the Tkinter app */
        body {
            background-color: #2e2e2e;
            color: white;
            font-family: 'Arial', sans-serif;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(14, minmax(0, 1fr));
            gap: 4px;
        }
        .grid-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
            font-size: clamp(0.5rem, 3.5vw, 0.8rem);
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .grid-cell:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .axis-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: clamp(0.6rem, 4vw, 0.9rem);
        }
        /* Initial hand colors */
        .suited { background-color: #4a7a96; }
        .off-suit { background-color: #4f4f4f; }
        .pair { background-color: #8fbc8f; }
        .hero {
            background-color: #FFD700 !important; /* Gold */
            color: #000000 !important;
            border: 2px solid white;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <h1 id="title-label" class="text-2xl font-bold text-center mb-6">正在加载胜率数据...</h1>
        
        <div id="heatmap-grid" class="grid-container">
            <!-- Grid will be generated by JavaScript -->
        </div>
    </div>

    <script>
        const ranks = 'AKQJT98765432';
        const gridElement = document.getElementById('heatmap-grid');
        const titleLabel = document.getElementById('title-label');
        
        let equityDatabase = null;
        const gridCells = {};

        /**
         * Initializes the application by generating the grid and loading data.
         * This version includes added debugging logs.
         */
        async function initialize() {
            generateGrid();
            
            // --- 新增的诊断代码 ---
            console.log("页面诊断信息开始：");
            console.log("当前页面地址 (window.location.href):", window.location.href);

            // 根据当前页面地址，构建json文件的完整URL
            const jsonUrl = new URL('full_equity_database.json', window.location.href);
            console.log("程序将尝试从这个URL加载数据:", jsonUrl.href);
            // --- 诊断代码结束 ---

            try {
                const response = await fetch(jsonUrl.href); // 使用构建好的完整URL
                if (!response.ok) {
                    console.error("服务器响应失败 (Server response was not OK):", response);
                    throw new Error(`HTTP 错误! 状态: ${response.status}`);
                }
                equityDatabase = await response.json();
                titleLabel.textContent = "请在网格中点击一手牌开始分析";
                console.log("胜率数据库加载成功。");
            } catch (error) {
                titleLabel.textContent = "错误：加载数据失败，请按F12查看控制台。";
                console.error("加载胜率数据库时发生致命错误 (Fatal error loading equity database):", error);
            }
        }

        /**
         * Generates the 14x14 grid (including axis labels) and populates it in the DOM.
         */
        function generateGrid() {
            // Top axis row
            gridElement.appendChild(document.createElement('div')); // Top-left empty corner
            for (const rank of ranks) {
                const axisLabel = document.createElement('div');
                axisLabel.className = 'axis-label';
                axisLabel.textContent = rank;
                gridElement.appendChild(axisLabel);
            }

            // Main grid rows
            for (let r_idx = 0; r_idx < ranks.length; r_idx++) {
                // Left axis label
                const axisLabel = document.createElement('div');
                axisLabel.className = 'axis-label';
                axisLabel.textContent = ranks[r_idx];
                gridElement.appendChild(axisLabel);

                // Hand cells
                for (let c_idx = 0; c_idx < ranks.length; c_idx++) {
                    const r1 = ranks[r_idx];
                    const r2 = ranks[c_idx];
                    let text, className;

                    if (r_idx < c_idx) { 
                        text = `${r1}${r2}s`;
                        className = 'grid-cell suited';
                    } else if (c_idx < r_idx) {
                        text = `${r2}${r1}o`;
                        className = 'grid-cell off-suit';
                    } else {
                        text = `${r1}${r2}`;
                        className = 'grid-cell pair';
                    }
                    
                    const cell = document.createElement('div');
                    cell.className = className;
                    cell.textContent = text;
                    cell.dataset.hand = text;
                    cell.addEventListener('click', () => displayHeatmap(text));
                    
                    gridElement.appendChild(cell);
                    gridCells[text] = cell;
                }
            }
        }

        /**
         * Displays the heatmap for a selected hero hand.
         * @param {string} heroHandText - The selected hand, e.g., "AKs".
         */
        function displayHeatmap(heroHandText) {
            if (!equityDatabase) {
                console.warn("数据库未加载，无法显示热力图。");
                return;
            }
            
            resetGridVisuals();
            titleLabel.textContent = `英雄手牌: ${heroHandText}`;

            const results = equityDatabase[heroHandText];
            if (!results) {
                console.error(`数据库中未找到手牌 '${heroHandText}' 的数据。`);
                return;
            }

            for (const [villainHand, equity] of Object.entries(results)) {
                updateGridCell(villainHand, equity);
            }
            
            markHeroCell(heroHandText);
        }
        
        /**
         * Resets all grid cells to their initial visual state.
         */
        function resetGridVisuals() {
            for (const [hand, cell] of Object.entries(gridCells)) {
                cell.textContent = hand;
                cell.classList.remove('hero');
                
                cell.style.backgroundColor = '';
                cell.style.color = 'white';

                if (hand.length === 3 && hand.endsWith('s')) {
                    cell.className = 'grid-cell suited';
                } else if (hand.length === 3 && hand.endsWith('o')) {
                    cell.className = 'grid-cell off-suit';
                } else {
                    cell.className = 'grid-cell pair';
                }
            }
        }

        /**
         * Updates a single grid cell with equity data.
         * @param {string} handText - The hand corresponding to the cell.
         * @param {number} equity - The equity percentage.
         */
        function updateGridCell(handText, equity) {
            const cell = gridCells[handText];
            if (cell) {
                const bgColor = getColorForEquity(equity);
                const fgColor = getTextColorForBg(bgColor);
                cell.style.backgroundColor = bgColor;
                cell.style.color = fgColor;
                cell.textContent = `${equity.toFixed(1)}%`;
            }
        }

        /**
         * Highlights the selected hero hand's cell.
         * @param {string} heroHand - The hero hand text.
         */
        function markHeroCell(heroHand) {
            const heroCell = gridCells[heroHand];
            if (heroCell) {
                heroCell.classList.add('hero');
                heroCell.textContent = "英雄";
            }
        }

        // --- Color Calculation Functions (Ported from Python) ---
        function getColorForEquity(equity) {
            const e = Math.max(0, Math.min(100, equity)) / 100.0;
            const blue = [23, 92, 201];
            const yellow = [255, 255, 224];
            const red = [214, 40, 40];
            let r, g, b;

            if (e < 0.5) {
                const t = e * 2;
                r = Math.round(blue[0] * (1 - t) + yellow[0] * t);
                g = Math.round(blue[1] * (1 - t) + yellow[1] * t);
                b = Math.round(blue[2] * (1 - t) + yellow[2] * t);
            } else {
                const t = (e - 0.5) * 2;
                r = Math.round(yellow[0] * (1 - t) + red[0] * t);
                g = Math.round(yellow[1] * (1 - t) + red[1] * t);
                b = Math.round(yellow[2] * (1 - t) + red[2] * t);
            }
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        function getTextColorForBg(bgHex) {
            const hex = bgHex.lstrip('#');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
            return brightness > 150 ? '#000000' : '#FFFFFF';
        }

        // Start the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

